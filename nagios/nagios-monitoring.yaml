dsl_definitions:
  app_cause_icmp: &app_cause_icmp
    workflow_id: heal
    parameters:
      node_instance_id: "{{instance}}"
      diagnose_value: "app_cause_icmp_timeout - VM is unreachable, ICMP timeout detected."

  app_cause_snmp_cpu: &app_cause_snmp_cpu
    workflow_id: scale
    parameters:
      scalable_entity_name: "scalable_compute"
      delta: 1

  v3_snmp: &v3_snmp
    username: { get_secret: snmp_user }
    auth_pass: { get_secret: snmp_pass }
    priv_pass: { get_secret: snmp_pass }

inputs:
  cpu_idle_threshold:
    type: integer
    default: 20
    description: >
      idle percentage to trigger scale
node_templates:
  app_vm_heal_target_type:
    type: cloudify.nagios.nodes.TargetType
    properties:
      name: app_vm_heal_target_type
      alias: Alias of app_vm_heal_target_type
      instance_health_check: check-host-icmp
      action_on_instance_failure: *app_cause_icmp
      check_interval: 0.25
      max_check_retries: 5
      snmp_properties:
        v3: *v3_snmp
    relationships:
      - type: cloudify.nagios.configuration_for_nagios_server
        target: nagios

  cluster_scale_target_type:
    type: cloudify.nagios.nodes.TargetType
    properties:
      name: cluster_scale_target_type
      alias: Alias of cluster_scale_target_type
      instance_health_check: do-not-check
      max_check_retries: 3
      snmp_properties:
        v3: *v3_snmp
    relationships:
      - type: cloudify.nagios.configuration_for_nagios_server
        target: nagios
      - type: cloudify.nagios.target_type_checks
        target: cpu_load_check

  cpu_load_check:
    type: cloudify.nagios.nodes.SNMPValueCheck
    properties:
      check_description: Get cpu idle
      snmp_oid: .1.3.6.1.4.1.2021.11.11.0
      low_critical_threshold: { get_input: cpu_idle_threshold }
      action_on_low_threshold: *app_cause_snmp_cpu
      check_interval: 0.25
      max_check_retries: 0
    relationships:
      - type: cloudify.relationships.contained_in
        target: nagios
