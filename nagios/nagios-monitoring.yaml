dsl_definitions:
  app_cause_icmp: &app_cause_icmp
    workflow_id: heal
    parameters:
      node_instance_id: "{{instance}}"
      diagnose_value: "app_cause_icmp_timeout - VM is unreachable, ICMP timeout detected."

  app_cause_snmp_cpu: &app_cause_snmp_cpu
    workflow_id: scale
    parameters:
      scalable_entity_name: "scalable_compute"
      delta: 1

  app_cause_snmp_ram: &app_cause_snmp_ram
    workflow_id: execute_operation
    parameters:
      operation: cloudify.interfaces.lifecycle.create
      operation_kwargs:
        args:
          hardwareProfile:
            vmSize: Standard_A2_v2
      run_by_dependency_order: false
      type_names: []
      node_ids:
        - webserver_vm
      node_instance_ids: []

  app_cause_snmp_storage: &app_cause_snmp_storage
    workflow_id: execute_operation
    parameters:
      operation: cloudify.interfaces.lifecycle.create
      operation_kwargs:
        args:
          hardwareProfile:
            vmSize: Standard_A1_v2
          storageProfile:
            os_disk:
              diskSizeGB: 70
      allow_kwargs_override: true
      run_by_dependency_order: false
      type_names: []
      node_ids:
        - webserver_vm
      node_instance_ids: []

  v3_snmp: &v3_snmp
    username: { get_secret: snmp_user }
    auth_pass: { get_secret: snmp_pass }
    priv_pass: { get_secret: snmp_pass }

inputs:
  cpu_idle_threshold:
    type: integer
    default: 20
    description: >
      idle percentage to trigger scale-out

node_templates:
  app_vm_heal_target_type:
    type: cloudify.nagios.nodes.TargetType
    properties:
      name: app_vm_heal_target_type
      alias: Ping to check instance health
      instance_health_check: check-host-icmp
      action_on_instance_failure: *app_cause_icmp
      check_interval: 0.25
      max_check_retries: 3
      snmp_properties:
        v3: *v3_snmp
    relationships:
      - type: cloudify.nagios.target_type_checks
        target: reachability_check
      - type: cloudify.nagios.configuration_for_nagios_server
        target: nagios

  reachability_check:
    type: cloudify.nagios.nodes.SNMPValueCheck
    properties:
      check_description: 1 minute load average
      snmp_oid: UCD-SNMP-MIB::laLoad.1

  cluster_scale_target_type:
    type: cloudify.nagios.nodes.TargetType
    properties:
      name: cluster_scale_target_type
      alias: Alias of cluster_scale_target_type
      instance_health_check: do-not-check
      max_check_retries: 3
      snmp_properties:
        v3: *v3_snmp
    relationships:
      - type: cloudify.nagios.configuration_for_nagios_server
        target: nagios
      - type: cloudify.nagios.target_type_checks
        target: cpu_load_check
      - type: cloudify.nagios.target_type_checks
        target: storage_check
      # - type: cloudify.nagios.target_type_checks
      #   target: ram_check

  cpu_load_check:
    type: cloudify.nagios.nodes.SNMPValueCheck
    properties:
      check_description: Get cpu idle
      snmp_oid: UCD-SNMP-MIB::ssCpuIdle.0
      low_critical_threshold: { get_input: cpu_idle_threshold }
      action_on_low_threshold: *app_cause_snmp_cpu
      check_interval: 0.25
      max_check_retries: 0
    relationships:
      - type: cloudify.relationships.contained_in
        target: nagios

  storage_check:
    type: cloudify.nagios.nodes.SNMPValueCheck
    properties:
      check_description: Get flag value for free space below threshold
      snmp_oid: UCD-SNMP-MIB::dskErrorFlag.1
      high_critical_threshold: 1
      action_on_high_threshold: *app_cause_snmp_storage
      check_interval: 0.25
      max_check_retries: 0
    relationships:
      - type: cloudify.relationships.contained_in
        target: nagios

  # ram_check:
  #   type: cloudify.nagios.nodes.SNMPAggregateValueCheck
  #   properties:
  #     check_description: Get sum of used ram
  #     snmp_oids: .1.3.6.1.4.1.2021.4.6, .1.3.6.1.4.1.2021.4.15, .1.3.6.1.4.1.2021.4.14
  #     low_critical_threshold: 1613591
  #     action_on_low_threshold: *app_cause_snmp_ram
  #     aggregation_type: sum
  #     check_interval: 0.25
  #     max_check_retries: 0
  #     on_unknown: ignore
  #   relationships:
  #     - type: cloudify.relationships.contained_in
  #       target: nagios
