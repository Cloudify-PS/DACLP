tosca_definitions_version: cloudify_dsl_1_3


imports:
  - https://cloudify.co/spec/cloudify/5.1.0/types.yaml

inputs:
  target_resource_tenant:
    description: >
      Defines resource tenant.
    type: string
    default: Dev
    constraints:
      - valid_values:
        - Test
        - Dev
        - Prod

  location:
    type: string
    description: Azure Region
    default: eastus2

  resource_group:
    default: daclp-group

  webserver_vm_size:
    default: Standard_A1_v2

  webserver_vm_image:
    default:
      publisher: Canonical
      offer: UbuntuServer
      sku: 18.04-LTS
      version: latest

  webserver_vm_os_family:
    default: linux

  webserver_vm_os_username:
    default: azureuser

  cpu_idle_threshold:
    type: integer
    default: 20
    description: >
      idle percentage to trigger scaling

  f5_virtual_machine_size:
    description: Name of Virtual Machine Size in Azure.
    default: Standard_DS4_v2

  f5_virtual_machine_image_sku:
    description: An instance of an offer, such as a major release of a distribution.
    default: 'f5-big-all-1slot-byol'

  f5_virtual_machine_image_publisher:
    description: Name of the organization that created the image.
    default: 'f5-networks'

  f5_virtual_machine_image_offer:
    description: The name of a group of related images created by a publisher.
    default: 'f5-big-ip-byol'

  retry_after:
    type: integer
    default: 60

  f5_network_api_version:
    description: API Version for Network
    default: "2015-06-15"

  azure_network_deployment_name:
    description: Name of deployment responsible for creation resource group, security group and networks.
    default: azure-vm-deployment

  f5_resource_prefix:
    description: Prefix of every resource created at this deployment on Azure.
    default: { get_secret: resource_prefix }

  f5_resource_suffix:
    description: Suffix of every resource created at this deployment on Azure.
    default: { get_secret: resource_suffix }


node_templates:
  azure_vm:
    type: cloudify.nodes.ServiceComponent
    properties:
      client:
        host: 127.0.0.1
        username: { get_secret: user_name }
        password: { get_secret: user_password }
        tenant: { get_input: target_resource_tenant }
      resource_config:
        blueprint:
          external_resource: false
          id: azure-vm-bp
          blueprint_archive: https://github.com/Cloudify-PS/DACLP/archive/refs/heads/dev.zip
          main_file_name: blueprint-azure.yaml
        deployment:
          id: azure-vm-deployment
          auto_inc_suffix: false
          inputs:
            location: { get_input: location }
            resource_group: { get_input: resource_group }
            webserver_vm_size: { get_input: webserver_vm_size }
            webserver_vm_image: { get_input: webserver_vm_image }
            webserver_vm_os_family: { get_input: webserver_vm_os_family }
            webserver_vm_os_username: { get_input: webserver_vm_os_username }

  nagios_monitoring:
    type: cloudify.nodes.ServiceComponent
    properties:
      client:
        host: 127.0.0.1
        username: { get_secret: user_name }
        password: { get_secret: user_password }
        tenant: { get_input: target_resource_tenant }
      resource_config:
        blueprint:
          external_resource: false
          id: nagios-bp
          blueprint_archive: https://github.com/Cloudify-PS/DACLP/archive/refs/heads/dev.zip
          main_file_name: blueprint-nagios.yaml
        deployment:
          id: nagios-deployment
          auto_inc_suffix: false
          inputs:
            cpu_idle_threshold: { get_input: cpu_idle_threshold }

  f5_bigip:
    type: cloudify.nodes.ServiceComponent
    properties:
      client:
        host: 127.0.0.1
        username: { get_secret: user_name }
        password: { get_secret: user_password }
        tenant: { get_input: target_resource_tenant }
      resource_config:
        blueprint:
          external_resource: false
          id: f5-bigip-bp
          blueprint_archive: https://github.com/Cloudify-PS/DACLP/archive/refs/heads/dev.zip
          main_file_name: blueprint-f5-bigip.yaml
        deployment:
          id: { get_input: f5_prov_name }
          auto_inc_suffix: false
          inputs:
            virtual_machine_size: { get_input: f5_virtual_machine_size }
            virtual_machine_image_sku: { get_input: f5_virtual_machine_image_sku }
            virtual_machine_image_publisher: { get_input: f5_virtual_machine_image_publisher }
            virtual_machine_image_offer: { get_input: f5_virtual_machine_image_offer }
            retry_after: { get_input: retry_after }
            network_api_version: { get_input: f5_network_api_version }
            azure_network_deployment_name: { get_input: azure_network_deployment_name }
            resource_prefix: { get_input: f5_resource_prefix }
            resource_suffix: { get_input: f5_resource_suffix }
    relationships:
      - type: cloudify.relationships.depends_on
        target: azure_vm
