tosca_definitions_version: cloudify_dsl_1_3


imports:
  - https://cloudify.co/spec/cloudify/5.1.0/types.yaml

inputs:
  deployment_version:
    type: string

  app_server_type:
    description: >
      Choose the server type that the application will be hosted on.
    type: string
    default: nginx
    constraints:
      - valid_values:
        - nginx
        - nodejs

  target_resource_tenant:
    description: >
      Defines resource tenant.
    type: string
    default: Dev
    constraints:
      - valid_values:
        - Test
        - Dev
        - Prod

  location:
    type: string
    description: Azure Region
    default: westeurope

  resource_group:
    default: dhl-poc-rg

  webserver_vm_size:
    default: Standard_A1_v2

  webserver_vm_image:
    default:
      publisher: Canonical
      offer: UbuntuServer
      sku: 18.04-LTS
      version: latest

  webserver_vm_os_family:
    default: linux

  webserver_vm_os_username:
    default: azureuser

  cpu_idle_threshold:
    type: integer
    default: 20
    description: >
      idle percentage to trigger scale-out

  used_storage_percentage_threshold:
    type: integer
    default: 50
    description: >
      Percentage of used storage to trigger storage scale-up.

node_templates:
  nagios_monitoring:
    type: cloudify.nodes.ServiceComponent
#    type: cloudify.nodes.SharedResource
    properties:
      client:
        host: 127.0.0.1
        username: { get_secret: cloudify_manager_user_name }
        password: { get_secret: cloudify_manager_user_password }
        tenant: { get_input: target_resource_tenant }
      resource_config:
#        deployment:
#          id: nagios_monitoring_xn7skz
        blueprint:
          external_resource: true
          id: { concat: [{get_input: deployment_version}, _nagios] }
        deployment:
          inputs:
            cpu_idle_threshold: { get_input: cpu_idle_threshold }
            location: { get_input: location }
            resource_group: { get_input: resource_group }
            used_storage_percentage_threshold: { get_input: used_storage_percentage_threshold }

  f5_bigip:
    type: cloudify.nodes.ServiceComponent
    properties:
      client:
        host: 127.0.0.1
        username: { get_secret: cloudify_manager_user_name }
        password: { get_secret: cloudify_manager_user_password }
        tenant: { get_input: target_resource_tenant }
      resource_config:
        blueprint:
          external_resource: true
          id: { concat: [{get_input: deployment_version}, _bigip] }
        deployment:
          # id: f5-bigip-deployment
          # id: { concat: [{get_input: deployment_version}, f5-bigip-deployment] }
          # auto_inc_suffix: false
          inputs:
            location: { get_input: location }
            resource_group: { get_input: resource_group }
            virtual_machine_size: Standard_DS4_v2
            virtual_machine_image_sku: 'f5-big-all-1slot-byol'
            virtual_machine_image_publisher: 'f5-networks'
            virtual_machine_image_offer: 'f5-big-ip-byol'
            retry_after: 60
            network_api_version: "2015-06-15"
            resource_prefix: ""
            resource_suffix: ""

  azure_vm:
    type: cloudify.nodes.ServiceComponent
    properties:
      client:
        host: 127.0.0.1
        username: { get_secret: cloudify_manager_user_name }
        password: { get_secret: cloudify_manager_user_password }
        tenant: { get_input: target_resource_tenant }
      resource_config:
        blueprint:
          external_resource: true
          id: { concat: [{get_input: deployment_version}, _, { get_input: app_server_type }] }
        deployment:
          inputs:
            location: { get_input: location }
            resource_group: { get_input: resource_group }
            webserver_vm_size: { get_input: webserver_vm_size }
            webserver_vm_image: { get_input: webserver_vm_image }
            webserver_vm_os_family: { get_input: webserver_vm_os_family }
            webserver_vm_os_username: { get_input: webserver_vm_os_username }
            deployment_id: azure-vm-deployment
            nagios_address: { get_attribute: [nagios_monitoring, capabilities, nagios_address] }
            nagios_ssl_certificate: { get_attribute: [nagios_monitoring, capabilities, nagios_ssl_certificate] }
            nagios_user: { get_attribute: [nagios_monitoring, capabilities, nagios_user] }
            nagios_password: { get_attribute: [nagios_monitoring, capabilities, nagios_password] }
            f5_mgmt_ip: { get_attribute: [f5_bigip, capabilities, mgmt_public_ip] }
            f5_wan_ip: { get_attribute: [f5_bigip, capabilities, wan_ip] }
            f5_public_ip: { get_attribute: [f5_bigip, capabilities, public_ip] }
    relationships:
      - type: cloudify.relationships.depends_on
        target: nagios_monitoring
      - type: cloudify.relationships.depends_on
        target: f5_bigip

outputs:
  resource_group:
    value: { get_attribute: [azure_vm, capabilities, resource_group] }

  location:
    value: { get_attribute: [azure_vm, capabilities, location] }

  nagios_private_address:
    value: { get_attribute: [nagios_monitoring, capabilities, nagios_address] }

  nagios_public_address:
    value: { get_attribute: [nagios_monitoring, capabilities, nagios_public_address] }

  nagios_web_ui_endpoint:
    value: { get_attribute: [nagios_monitoring, capabilities, nagios_web_ui_endpoint] }

  nagios_ssl_certificate:
    value: { get_attribute: [nagios_monitoring, capabilities, nagios_ssl_certificate] }

  nagios_user:
    value: { get_attribute: [nagios_monitoring, capabilities, nagios_user] }

  nagios_password:
    value: { get_attribute: [nagios_monitoring, capabilities, nagios_password] }

  f5_load_balancer_ip:
    value: { get_attribute: [f5_bigip, capabilities, public_public_ip] }

  f5_web_ui_endpoint:
    value: { get_attribute: [f5_bigip, capabilities, f5_web_ui_endpoint] }
