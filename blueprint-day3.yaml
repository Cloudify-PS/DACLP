tosca_definitions_version: cloudify_dsl_1_3


imports:
  - https://cloudify.co/spec/cloudify/5.1.0/types.yaml

inputs:
  app_server_type:
    description: >
      Choose the server type that the application will be hosted on.
    type: string
    default: nginx
    constraints:
      - valid_values:
        - nginx
        - nodejs

  target_resource_tenant:
    description: >
      Defines resource tenant.
    type: string
    default: Dev
    constraints:
      - valid_values:
        - Test
        - Dev
        - Prod

  location:
    type: string
    description: Azure Region
    default: westeurope

  resource_group:
    default: dhl-poc-rg

  webserver_vm_size:
    default: Standard_A1_v2

  webserver_vm_image:
    default:
      publisher: Canonical
      offer: UbuntuServer
      sku: 18.04-LTS
      version: latest

  webserver_vm_os_family:
    default: linux

  webserver_vm_os_username:
    default: azureuser

  cpu_idle_threshold:
    type: integer
    default: 20
    description: >
      idle percentage to trigger scale-out

  free_storage_percentage_threshold:
    type: integer
    default: 25
    description: >
      Percentage of free storage to trigger storage scale-up.
      Workflow will be started if the percentage of free space is below the specified value

  f5_virtual_machine_size:
    description: Name of Virtual Machine Size in Azure.
    default: Standard_DS4_v2

  f5_virtual_machine_image_sku:
    description: An instance of an offer, such as a major release of a distribution.
    default: 'f5-big-all-1slot-byol'

  f5_virtual_machine_image_publisher:
    description: Name of the organization that created the image.
    default: 'f5-networks'

  f5_virtual_machine_image_offer:
    description: The name of a group of related images created by a publisher.
    default: 'f5-big-ip-byol'

  retry_after:
    type: integer
    default: 60

  f5_network_api_version:
    description: API Version for Network
    default: "2015-06-15"

  azure_network_deployment_name:
    description: Name of deployment responsible for creation resource group, security group and networks.
    default: azure-vm-deployment

  f5_resource_prefix:
    description: Prefix of every resource created at this deployment on Azure.
    default: ""

  f5_resource_suffix:
    description: Suffix of every resource created at this deployment on Azure.
    default: ""

node_templates:
  nagios_monitoring:
    type: cloudify.nodes.ServiceComponent
    properties:
      client:
        host: 127.0.0.1
        username: { get_secret: cloudify_manager_user_name }
        password: { get_secret: cloudify_manager_user_password }
        tenant: { get_input: target_resource_tenant }
      resource_config:
        blueprint:
          external_resource: false
          id: nagios-bp
          blueprint_archive: https://github.com/Cloudify-PS/DACLP/archive/refs/heads/day3_dev.zip
          main_file_name: blueprint-nagios.yaml
        deployment:
          id: nagios-deployment
          auto_inc_suffix: false
          inputs:
            cpu_idle_threshold: { get_input: cpu_idle_threshold }
            location: { get_input: location }
            resource_group: { get_input: resource_group }
            cpu_idle_threshold: { get_input: cpu_idle_threshold }
            storage_percentage_threshold: { get_input: storage_percentage_threshold }

  azure_vm:
    type: cloudify.nodes.ServiceComponent
    properties:
      client:
        host: 127.0.0.1
        username: { get_secret: cloudify_manager_user_name }
        password: { get_secret: cloudify_manager_user_password }
        tenant: { get_input: target_resource_tenant }
      resource_config:
        blueprint:
          external_resource: false
          id: { concat: ['azure-vm-', { get_input: app_server_type }, '-bp'] }
          blueprint_archive: https://github.com/Cloudify-PS/DACLP/archive/refs/heads/day3_dev.zip
          main_file_name: { concat: ['blueprint-azure-', { get_input: app_server_type }, '.yaml'] }
        deployment:
          id: azure-vm-deployment
          auto_inc_suffix: false
          inputs:
            location: { get_input: location }
            resource_group: { get_input: resource_group }
            webserver_vm_size: { get_input: webserver_vm_size }
            webserver_vm_image: { get_input: webserver_vm_image }
            webserver_vm_os_family: { get_input: webserver_vm_os_family }
            webserver_vm_os_username: { get_input: webserver_vm_os_username }
            deployment_id: azure-vm-deployment
            free_storage_percentage_threshold: { get_input: free_storage_percentage_threshold }
            nagios_address: { get_attribute: [nagios_monitoring, capabilities, nagios_address] }
            nagios_ssl_certificate: { get_attribute: [nagios_monitoring, capabilities, nagios_ssl_certificate] }
            nagios_user: { get_attribute: [nagios_monitoring, capabilities, nagios_user] }
            nagios_password: { get_attribute: [nagios_monitoring, capabilities, nagios_password] }
    relationships:
      - type: cloudify.relationships.depends_on
        target: nagios_monitoring

  f5_bigip:
    type: cloudify.nodes.ServiceComponent
    properties:
      client:
        host: 127.0.0.1
        username: { get_secret: cloudify_manager_user_name }
        password: { get_secret: cloudify_manager_user_password }
        tenant: { get_input: target_resource_tenant }
      resource_config:
        blueprint:
          external_resource: false
          id: f5-bigip-bp
          blueprint_archive: https://github.com/Cloudify-PS/DACLP/archive/refs/heads/day3_dev.zip
          main_file_name: blueprint-f5-bigip.yaml
        deployment:
          id: f5-bigip-deployment
          auto_inc_suffix: false
          inputs:
            location: { get_input: location }
            resource_group: { get_input: resource_group }
            virtual_machine_size: { get_input: f5_virtual_machine_size }
            virtual_machine_image_sku: { get_input: f5_virtual_machine_image_sku }
            virtual_machine_image_publisher: { get_input: f5_virtual_machine_image_publisher }
            virtual_machine_image_offer: { get_input: f5_virtual_machine_image_offer }
            retry_after: { get_input: retry_after }
            network_api_version: { get_input: f5_network_api_version }
            azure_network_deployment_name: { get_input: azure_network_deployment_name }
            resource_prefix: { get_input: f5_resource_prefix }
            resource_suffix: { get_input: f5_resource_suffix }
    relationships:
      - type: cloudify.relationships.depends_on
        target: azure_vm

outputs:
  resource_group:
    value: { get_attribute: [azure_vm, capabilities, resource_group] }

  location:
    value: { get_attribute: [azure_vm, capabilities, location] }

  webserver_vm_public_ip:
    value: { get_attribute: [azure_vm, capabilities, webserver_vm_public_ip] }

  webserver_vm_private_ip:
    value: { get_attribute: [azure_vm, capabilities, webserver_vm_private_ip] }

  nagios_private_address:
    value: { get_attribute: [nagios_monitoring, capabilities, nagios_address] }

  nagios_public_address:
    value: { get_attribute: [nagios_monitoring, capabilities, nagios_public_address] }

  nagios_ssl_certificate:
    value: { get_attribute: [nagios_monitoring, capabilities, nagios_ssl_certificate] }

  nagios_user:
    value: { get_attribute: [nagios_monitoring, capabilities, nagios_user] }

  nagios_password:
    value: { get_attribute: [nagios_monitoring, capabilities, nagios_password] }

  f5_mgmt_public_ip:
    value: { get_attribute: [f5_bigip, capabilities, mgmt_public_ip] }

  f5_wan_ip:
    value: { get_attribute: [f5_bigip, capabilities, wan_ip] }

  f5_public_ip:
    value: { get_attribute: [f5_bigip, capabilities, public_ip] }

  f5_public_public_ip:
    value: { get_attribute: [f5_bigip, capabilities, public_public_ip] }
